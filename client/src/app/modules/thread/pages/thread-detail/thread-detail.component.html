<div class="row">
  <ng-container *ngIf="(data$ | async) as data">
    <div class="col-12 col-md-8">

      <div class="blog-post">
        <h2 class="blog-post-title">{{ data.thread.title }}</h2>
        <div class="flex-inline">
          <p class="blog-post-meta">{{ data.thread.createdAt | amDateFormat:'LL' }} by
            <a [routerLink]="['/profile', data.thread.creator.fullName]">{{ data.thread.creator.fullName }}</a>
          </p>
          <ng-container *ngIf="data.isLoggedIn">
            <ng-container *ngIf="data.authUser.userObject.id === data.thread.creator.id">
              <div>
                <button mat-icon-button [matMenuTriggerFor]="moreOptions" aria-label="Delete thread">
                  <mat-icon>more_vert</mat-icon>
                </button>
                <mat-menu #moreOptions="matMenu" yPosition="below">
                  <button mat-menu-item (click)="deleteThread(data.thread.id)">
                    <mat-icon>delete</mat-icon>
                    <span>Delete</span>
                  </button>
                  <!-- <button mat-menu-item disabled>
                                        <mat-icon>voicemail</mat-icon>
                                        <span>Check voice mail</span>
                                      </button>
                                      <button mat-menu-item>
                                        <mat-icon>notifications_off</mat-icon>
                                        <span>Disable alerts</span>
                                      </button> -->
                </mat-menu>
              </div>
            </ng-container>
          </ng-container>
        </div>
        <hr>
        <p>{{ data.thread.body }}</p>
      </div>

      <!--Comments-->
      <h5>{{ data.thread.replies.length | pluralize : 'comment' }}</h5>

      <ng-container *ngIf="data.thread.replies.length">
        <ng-container *ngFor="let reply of data.thread.replies">
          <div class="card mb-3">

            <div class="card-header flex-inline">
              <!-- Reply profile Image, Name and Time Stamp  -->
              <div>
                <img class="reply-profile-img" src="https://mdbootstrap.com/img/Photos/Avatars/img (20).jpg" alt="Generic placeholder image">
                <a class="ml-1" [routerLink]="['/profile', reply.user.fullName]">{{ reply.user.fullName }}</a>
                <small class="ml-1">{{ reply.createdAt | amTimeAgo }}</small>
              </div>
              <!-- End Reply profile Image, Name and Time Stamp  -->

              <!-- Favorite button -->
              <ng-container *ngIf="data.isLoggedIn">
                <button mat-stroked-button (click)="addFavorite(reply.id)"
                  [disabled]="disabled(data.authUser.userObject.id, reply.favorites)">
                  {{ reply.favorites.length | pluralize : 'Favorite' }}
                </button>
              </ng-container>
              <!-- End Favorite button -->
            </div>

            <!-- Reply body -->
            <div class="card-body">
              <ng-container *ngIf="editing; else elseReplyBody">
                <!-- Edit Reply Form -->
                <form (ngSubmit)="updateReply(reply.id)" [formGroup]="editReplyForm" novalidate>
                  <div class="form-group">
                    <label for="body" class="sr-only">Body</label>
                    <textarea class="form-control" formControlName="body"></textarea>
                  </div>
                  <ng-container>
                    <!-- <mat-spinner *ngIf="editSpinner" diameter="20"></mat-spinner> -->
                    <button type="submit" class="btn btn-primary btn-xs">Update</button>
                  </ng-container>
                  <button type="button" (click)="editing = false" class="btn btn-link btn-xs">Cancel</button>
                </form>
                <!-- End Edit Reply Form -->
              </ng-container>
              <ng-template #elseReplyBody>
                <p>{{ reply.body }}</p>
              </ng-template>
            </div>
            <!-- End Reply body -->

            <!-- Reply Card footer Edit and Delete -->
            <ng-container *ngIf="data.isLoggedIn">
              <ng-container *ngIf="data.authUser.userObject.id === reply.userId">
                <div class="card-footer">
                  <button type="button" (click)="editReply(reply.body)" class="btn btn-secondary btn-sm mr-2">Edit</button>
                  <button type="button" (click)="deleteReply(reply.id)" class="btn btn-danger btn-sm">Delete</button>
                </div>
              </ng-container>
            </ng-container>
            <!-- End Reply Card footer Edit and Delete -->

          </div>
        </ng-container>
      </ng-container>

      <!-- Paginate Comments -->
      <nav aria-label="Page navigation example">
        <ul class="pagination justify-content-center">
          <li class="page-item">
            <a class="page-link" href="#" aria-label="Previous">
              <span aria-hidden="true">&laquo;</span>
              <span class="sr-only">Previous</span>
            </a>
          </li>
          <li class="page-item"><a class="page-link" href="#">1</a></li>
          <li class="page-item"><a class="page-link" href="#">2</a></li>
          <li class="page-item"><a class="page-link" href="#">3</a></li>
          <li class="page-item">
            <a class="page-link" href="#" aria-label="Next">
              <span aria-hidden="true">&raquo;</span>
              <span class="sr-only">Next</span>
            </a>
          </li>
        </ul>
      </nav>
      <!--/.Comments-->

      <!--Reply-->
      <ng-container *ngIf="data.isLoggedIn">
        <div class="card mb-3 wow fadeIn">
          <div class="card-header font-weight-bold">Leave a reply</div>
          <div class="card-body">

            <!-- Default form reply -->
            <form (ngSubmit)="addReply(data.thread.id)" [formGroup]="replyForm" novalidate>

              <!-- Comment -->
              <div class="form-group">
                <label for="comment">Your comment</label>
                <textarea class="form-control" formControlName="body" rows="5"></textarea>
              </div>

              <div class="mt-4">
                <mat-spinner *ngIf="loading" diameter="50"></mat-spinner>
                <button *ngIf="!loading" mat-flat-button color="primary"
                  [title]="replyForm.valid ? 'Click to submit' : 'Disabled until the form data is valid'"
                  [disabled]="replyForm.invalid">Post</button>
              </div>
            </form>
            <!-- Default form reply -->
          </div>
        </div>
      </ng-container>
      <ng-container *ngIf="!data.isLoggedIn">
        <p class="text-center">Please <span class="btn-link" (click)="signIn()">sign in</span> to participate in this
          discussion.</p>
      </ng-container>
      <!--/.Reply-->
    </div>

    <div class="col-12 col-md-4">
      <div class="card mb-3 wow fadeIn">
        <div class="card-body">
          <p class="blog-post-meta">
            This thread was published
            {{ data.thread.createdAt | amTimeAgo }} by <a [routerLink]="['/profile', data.thread.creator.fullName]">{{ data.thread.creator.fullName }}</a>, and
            currently has {{ data.thread.replies.length | pluralize : 'comment' }}.
          </p>
        </div>
      </div>
    </div>
  </ng-container>

  <div *ngIf="errorMessage$ | async as errorMessage">
    {{ errorMessage }}
  </div>
</div>
